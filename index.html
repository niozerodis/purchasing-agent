<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的代購小幫手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Microsoft JhengHei, sans-serif;
        background-color: #f3f4f6;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div id="app" class="min-h-screen pb-10">
      <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16 items-center">
            <div class="flex items-center">
              <i
                class="fa-solid fa-bag-shopping text-indigo-600 text-2xl mr-2"
              ></i>
              <h1 class="text-xl font-bold text-gray-800">代購紀錄小幫手</h1>
              <div class="flex items-center ml-4 space-x-3">
                <span v-if="isLoading" class="text-sm text-gray-500"
                  ><i class="fa-solid fa-spinner fa-spin"></i> 讀取中...</span
                >
                <span v-if="isSaving" class="text-sm text-green-600"
                  ><i class="fa-solid fa-cloud-arrow-up fa-fade"></i>
                  處理中...</span
                >
              </div>
            </div>
            <button
              @click="openModal()"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-md flex items-center"
            >
              <i class="fa-solid fa-plus mr-1"></i> 新增紀錄
            </button>
          </div>
        </div>
      </nav>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div
          class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-3"
        >
          <div class="flex items-center gap-2 w-full sm:w-auto">
            <label class="text-sm font-bold text-gray-600 whitespace-nowrap"
              ><i class="fa-solid fa-table"></i> 當前分頁：</label
            >
            <div class="relative">
              <select
                v-model="currentSheetName"
                @change="fetchData()"
                class="appearance-none border border-gray-300 rounded pl-3 pr-8 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-700 bg-white cursor-pointer"
              >
                <option v-for="name in sheetList" :key="name" :value="name">
                  {{ name }}
                </option>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"
              >
                <i class="fa-solid fa-chevron-down text-xs"></i>
              </div>
            </div>

            <button
              @click="fetchData()"
              class="ml-2 bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-sm transition"
            >
              <i class="fa-solid fa-rotate-right"></i> 讀取
            </button>
          </div>

          <div class="flex items-center gap-2 w-full sm:w-auto justify-end">
            <button
              @click="createNewSheet"
              class="text-indigo-600 hover:bg-indigo-50 px-3 py-1 rounded text-sm transition border border-indigo-200"
            >
              <i class="fa-solid fa-folder-plus"></i> 建立新表
            </button>
            <button
              @click="deleteCurrentSheet"
              class="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-sm transition border border-red-200"
            >
              <i class="fa-solid fa-trash-can"></i> 刪除此表
            </button>
          </div>
        </div>
      </div>

      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"
      >
        <div
          class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500"
        >
          <div class="text-gray-500 text-xs font-semibold">本頁筆數</div>
          <div class="text-2xl font-bold text-gray-800">
            {{ items.length }} <span class="text-xs font-normal">筆</span>
          </div>
        </div>
        <div
          class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500"
        >
          <div class="text-gray-500 text-xs font-semibold">
            已收款總額 (台幣)
          </div>
          <div class="text-2xl font-bold text-gray-800">
            ${{ formatNumber(totalPaid) }}
          </div>
        </div>
        <div
          class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"
        >
          <div class="text-gray-500 text-xs font-semibold">
            未收款總額 (台幣)
          </div>
          <div class="text-2xl font-bold text-gray-800">
            ${{ formatNumber(totalUnpaid) }}
          </div>
        </div>
      </div>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="mb-4">
          <input
            v-model="searchQuery"
            type="text"
            placeholder="搜尋項目、買家或備註..."
            class="w-full sm:w-1/3 border-gray-300 border p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm"
          />
        </div>

        <div
          class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden"
        >
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  代購項目 / 商家
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  平台 / 匯率
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  金額試算
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  狀態 / 出貨
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  備註
                </th>
                <th
                  class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  操作
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr
                v-for="item in filteredItems"
                :key="item.id"
                class="hover:bg-gray-50 transition"
              >
                <td class="px-6 py-4">
                  <div class="text-sm font-bold text-gray-900">
                    {{ item.name }}
                  </div>
                  <div class="text-xs text-gray-500">{{ item.merchant }}</div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm text-gray-900">{{ item.platform }}</div>
                  <div class="text-xs text-gray-500">
                    {{ item.currency }} ({{ item.rate }})
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm font-bold text-indigo-600">
                    ${{ formatNumber(calculateTotal(item)) }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ item.originalPrice }} × {{ item.quantity }}
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span
                    :class="item.isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full mb-1"
                  >
                    {{ item.isPaid ? '已付款' : '未付款' }}
                  </span>
                  <div class="text-xs text-gray-500">
                    {{ item.shippingDate || '未定' }}
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                  {{ item.notes }}
                </td>
                <td class="px-6 py-4 text-right text-sm font-medium">
                  <button
                    @click="editItem(item)"
                    class="text-indigo-600 hover:text-indigo-900 mr-3"
                  >
                    <i class="fa-solid fa-pen"></i>
                  </button>
                  <button
                    @click="deleteItem(item.id)"
                    class="text-red-600 hover:text-red-900"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div
            v-if="filteredItems.length === 0"
            class="p-8 text-center text-gray-500"
          >
            此分頁沒有資料
          </div>
        </div>

        <div class="md:hidden space-y-4">
          <div
            v-for="item in filteredItems"
            :key="item.id"
            class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"
          >
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="font-bold text-gray-900">{{ item.name }}</h3>
                <p class="text-xs text-gray-500">
                  {{ item.platform }} | {{ item.merchant }}
                </p>
              </div>
              <span
                :class="item.isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                class="px-2 py-0.5 text-xs font-semibold rounded-full"
              >
                {{ item.isPaid ? '已付' : '未付' }}
              </span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
              <div class="bg-gray-50 p-2 rounded">
                <span class="text-xs text-gray-400 block">原幣</span>
                <span class="font-medium"
                  >{{ item.originalPrice }} {{ item.currency }}</span
                >
              </div>
              <div class="bg-indigo-50 p-2 rounded">
                <span class="text-xs text-indigo-400 block">台幣</span>
                <span class="font-bold text-indigo-700"
                  >${{ formatNumber(calculateTotal(item)) }}</span
                >
              </div>
            </div>
            <div class="flex justify-end border-t pt-2 gap-3">
              <button @click="editItem(item)" class="text-indigo-600 text-sm">
                <i class="fa-solid fa-pen"></i> 編輯
              </button>
              <button @click="deleteItem(item.id)" class="text-red-500 text-sm">
                <i class="fa-solid fa-trash"></i> 刪除
              </button>
            </div>
          </div>
        </div>
      </div>

      <transition name="fade">
        <div
          v-if="showModal"
          class="fixed inset-0 z-50 overflow-y-auto"
          role="dialog"
          aria-modal="true"
        >
          <div
            class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
          >
            <div
              class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
              @click="closeModal()"
            ></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
              >&#8203;</span
            >
            <div
              class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full"
            >
              <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                  {{ isEditing ? '編輯紀錄' : '新增紀錄' }}
                </h3>
                <form @submit.prevent="saveItem" class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >代購項目</label
                      ><input
                        v-model="form.name"
                        required
                        type="text"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >代購平台</label
                      ><input
                        v-model="form.platform"
                        type="text"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm"
                      />
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >商家</label
                      ><input
                        v-model="form.merchant"
                        type="text"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >幣值</label
                      ><select
                        v-model="form.currency"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm bg-white"
                      >
                        <option value="JPY">JPY</option>
                        <option value="USD">USD</option>
                        <option value="CNY">CNY</option>
                        <option value="TWD">TWD</option>
                      </select>
                    </div>
                  </div>
                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="grid grid-cols-3 gap-3">
                      <div>
                        <label class="block text-xs font-medium text-gray-500"
                          >單價</label
                        ><input
                          v-model.number="form.originalPrice"
                          type="number"
                          step="0.01"
                          class="mt-1 w-full border-gray-300 rounded p-1 text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-500"
                          >數量</label
                        ><input
                          v-model.number="form.quantity"
                          type="number"
                          class="mt-1 w-full border-gray-300 rounded p-1 text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-500"
                          >匯率</label
                        ><input
                          v-model.number="form.rate"
                          type="number"
                          step="0.0001"
                          class="mt-1 w-full border-gray-300 rounded p-1 text-sm"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >出貨時間</label
                      ><input
                        v-model="form.shippingDate"
                        type="date"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >收款方式</label
                      ><input
                        v-model="form.paymentMethod"
                        type="text"
                        list="methods"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm"
                      /><datalist id="methods">
                        <option value="轉帳" />
                        <option value="LinePay" />
                      </datalist>
                    </div>
                  </div>
                  <div class="flex items-center mt-2">
                    <input
                      id="paid"
                      v-model="form.isPaid"
                      type="checkbox"
                      class="h-4 w-4 text-indigo-600"
                    /><label
                      for="paid"
                      class="ml-2 block text-sm text-gray-900 font-bold"
                      >已付款</label
                    >
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >備註</label
                    ><textarea
                      v-model="form.notes"
                      rows="2"
                      class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm"
                    ></textarea>
                  </div>
                  <div class="pt-4 flex justify-end gap-3">
                    <button
                      type="button"
                      @click="closeModal()"
                      class="bg-white py-2 px-4 border border-gray-300 rounded text-sm text-gray-700"
                    >
                      取消</button
                    ><button
                      type="submit"
                      class="bg-indigo-600 text-white py-2 px-4 rounded text-sm font-medium hover:bg-indigo-700"
                    >
                      儲存
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const { createApp, ref, computed, onMounted } = Vue;

      createApp({
        setup() {
          // ★ 這裡請填入你的 Apps Script 網址
          const API_URL =
            "https://script.google.com/macros/s/AKfycbzrfKqSmXKnlXPgxc0_7OHcDSsIHvUo9reeAdqauNoPvzBCh2ryhoG5c04LQi9XYrIP/exec";

          const items = ref([]);
          const searchQuery = ref("");
          const isLoading = ref(false);
          const isSaving = ref(false);
          const showModal = ref(false);
          const isEditing = ref(false);
          const currentId = ref(null);

          // ★ 新增：當前分頁名稱 (預設為 data)
          const currentSheetName = ref("data");
          const sheetList = ref(["data"]);

          const defaultForm = {
            name: "",
            platform: "",
            merchant: "",
            currency: "JPY",
            originalPrice: 0,
            quantity: 1,
            rate: 0.23,
            isPaid: false,
            shippingDate: "",
            paymentMethod: "",
            notes: "",
          };
          const form = ref({ ...defaultForm });

          // ★ 取得密碼的輔助函式
          const getPassword = () => {
            let pwd = localStorage.getItem("my_app_password");
            if (!pwd) {
              pwd = prompt("請輸入管理員密碼：");
              if (pwd) localStorage.setItem("my_app_password", pwd);
            }
            return pwd;
          };

          // ★ 新增：取得分頁清單的函式
          const fetchSheetList = async () => {
            try {
              // 呼叫後端，帶上 action=get_sheets
              const res = await fetch(`${API_URL}?action=get_sheets`);
              const list = await res.json();

              if (Array.isArray(list)) {
                sheetList.value = list;

                // 如果目前選的分頁不在清單裡 (例如剛刪除完)，就自動選第一個
                if (!list.includes(currentSheetName.value) && list.length > 0) {
                  currentSheetName.value = list[0];
                }
              }
            } catch (e) {
              console.error("無法取得分頁清單", e);
            }
          };

          // ★ 讀取資料 (支援指定分頁)
          const fetchData = async () => {
            isLoading.value = true;
            items.value = []; // 切換時先清空，避免混淆
            try {
              // 透過 URL 參數告訴後端我要讀哪個分頁
              const url = `${API_URL}?sheet=${encodeURIComponent(
                currentSheetName.value
              )}`;
              const res = await fetch(url);
              const data = await res.json();

              if (data.error) {
                alert(`讀取錯誤：${data.error}`); // 例如找不到分頁
              } else {
                items.value = data.map((i) => ({
                  ...i,
                  isPaid: Boolean(i.isPaid),
                }));
              }
            } catch (error) {
              console.error(error);
              alert("讀取失敗");
            } finally {
              isLoading.value = false;
            }
          };

          // ★ 通用指令發送函式 (Save / Create / Delete)
          const sendCommand = async (action, extraData = {}) => {
            const userPassword = getPassword();
            if (!userPassword) return false;

            isSaving.value = true;
            try {
              const payload = {
                auth: userPassword,
                action: action, // 告訴後端要做什麼
                sheetName: currentSheetName.value, // 對哪個分頁操作
                ...extraData, // 附帶資料 (例如書單內容)
              };

              const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload),
              });
              const result = await res.json();

              if (result.status === "error") {
                alert(result.message);
                if (result.message.includes("密碼"))
                  localStorage.removeItem("my_app_password");
                return false;
              }
              return true; // 成功
            } catch (e) {
              alert("操作失敗，請檢查網路");
              return false;
            } finally {
              isSaving.value = false;
            }
          };

          // ★ 儲存資料
          const saveItem = async () => {
            // 先更新本地列表
            if (isEditing.value) {
              const idx = items.value.findIndex(
                (i) => i.id === currentId.value
              );
              if (idx !== -1)
                items.value[idx] = { ...form.value, id: currentId.value };
            } else {
              items.value.unshift({ ...form.value, id: Date.now() });
            }
            closeModal();

            // 發送指令到後端
            await sendCommand("save", { data: items.value });
          };

          const deleteItem = async (id) => {
            if (confirm("刪除此項目？")) {
              items.value = items.value.filter((i) => i.id !== id);
              await sendCommand("save", { data: items.value });
            }
          };

          // ★ 新增分頁功能
          const createNewSheet = async () => {
            const newName = prompt("請輸入新分頁名稱 (例如: 2024-06)：");
            if (!newName) return;

            // 檢查是否已存在
            if (sheetList.value.includes(newName)) {
              alert("分頁已存在，直接切換");
              currentSheetName.value = newName;
              fetchData();
              return;
            }

            // 暫時切換名稱去發送指令
            const oldName = currentSheetName.value;
            currentSheetName.value = newName;

            const success = await sendCommand("create_sheet");
            if (success) {
              alert("分頁建立成功！");
              items.value = []; // 新分頁是空的
              // ★ 關鍵：建立成功後，重新抓一次清單，這樣下拉選單才會出現新的
              await fetchSheetList();
              // 確保選中新的
              currentSheetName.value = newName;
            } else {
              currentSheetName.value = oldName; // 失敗就切回來
            }
          };

          // ★ 刪除分頁功能
          const deleteCurrentSheet = async () => {
            if (
              !confirm(
                `確定要刪除整個「${currentSheetName.value}」分頁嗎？此動作無法復原！`
              )
            )
              return;

            const success = await sendCommand("delete_sheet");
            if (success) {
              alert("分頁已刪除");
              // ★ 關鍵：刪除後更新清單
              await fetchSheetList();
              // 自動讀取新選中的分頁 (fetchSheetList 裡面有寫邏輯會自動跳轉)
              fetchData();
            }
          };

          // ★ 畫面載入時，先抓清單，再抓資料
          onMounted(async () => {
            await fetchSheetList(); // 先取得有哪些分頁
            await fetchData(); // 再讀取當前分頁資料
          });

          // 計算邏輯
          const calculateTotal = (i) =>
            Math.round(i.originalPrice * i.quantity * i.rate);
          const formatNumber = (n) =>
            n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          const totalPaid = computed(() =>
            items.value
              .filter((i) => i.isPaid)
              .reduce((s, i) => s + calculateTotal(i), 0)
          );
          const totalUnpaid = computed(() =>
            items.value
              .filter((i) => !i.isPaid)
              .reduce((s, i) => s + calculateTotal(i), 0)
          );
          const filteredItems = computed(() => {
            if (!searchQuery.value) return items.value;
            const q = searchQuery.value.toLowerCase();
            return items.value.filter(
              (i) =>
                i.name.toLowerCase().includes(q) ||
                (i.merchant && i.merchant.toLowerCase().includes(q))
            );
          });

          const openModal = () => {
            isEditing.value = false;
            form.value = { ...defaultForm };
            showModal.value = true;
          };
          const editItem = (item) => {
            isEditing.value = true;
            currentId.value = item.id;
            form.value = JSON.parse(JSON.stringify(item));
            showModal.value = true;
          };
          const closeModal = () => (showModal.value = false);

          return {
            items,
            searchQuery,
            isLoading,
            isSaving,
            showModal,
            isEditing,
            form,
            sheetList,
            currentSheetName, // 讓 HTML 可以綁定
            fetchSheetList,
            fetchData,
            createNewSheet,
            deleteCurrentSheet, // 新功能
            filteredItems,
            totalPaid,
            totalUnpaid,
            openModal,
            closeModal,
            saveItem,
            editItem,
            deleteItem,
            calculateTotal,
            formatNumber,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
