<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的代購小幫手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Microsoft JhengHei, sans-serif;
        background-color: #f3f4f6;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s ease;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div id="app" class="min-h-screen pb-10">
      <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16 items-center">
            <div class="flex items-center">
              <i
                class="fa-solid fa-bag-shopping text-indigo-600 text-2xl mr-2"
              ></i>
              <h1 class="text-xl font-bold text-gray-800">代購紀錄小幫手</h1>
              <div class="flex items-center ml-4">
                <span v-if="isLoading" class="text-sm text-gray-500"
                  ><i class="fa-solid fa-spinner fa-spin"></i>
                  讀取資料中...</span
                >
                <span v-if="isSaving" class="text-sm text-green-600"
                  ><i class="fa-solid fa-cloud-arrow-up fa-fade"></i>
                  資料儲存中...</span
                >
              </div>
            </div>
            <button
              @click="openModal()"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-md flex items-center"
            >
              <i class="fa-solid fa-plus mr-1"></i> 新增紀錄
            </button>
          </div>
        </div>
      </nav>

      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 grid grid-cols-2 md:grid-cols-4 gap-4"
      >
        <div
          class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500"
        >
          <div class="text-gray-500 text-xs font-semibold">總代購項目</div>
          <div class="text-2xl font-bold text-gray-800">
            {{ items.length }} <span class="text-xs font-normal">筆</span>
          </div>
        </div>
        <div
          class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500"
        >
          <div class="text-gray-500 text-xs font-semibold">
            已收款總額 (台幣)
          </div>
          <div class="text-2xl font-bold text-gray-800">
            ${{ formatNumber(totalPaid) }}
          </div>
        </div>
        <div
          class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"
        >
          <div class="text-gray-500 text-xs font-semibold">
            未收款總額 (台幣)
          </div>
          <div class="text-2xl font-bold text-gray-800">
            ${{ formatNumber(totalUnpaid) }}
          </div>
        </div>
      </div>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="mb-4 flex flex-col sm:flex-row gap-3">
          <input
            v-model="searchQuery"
            type="text"
            placeholder="搜尋項目、買家或備註..."
            class="w-full sm:w-1/3 border-gray-300 border p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none shadow-sm"
          />
        </div>

        <div
          class="hidden md:block bg-white rounded-xl shadow-sm overflow-hidden"
        >
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  代購項目 / 商家
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  平台 / 匯率
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  金額試算
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  狀態 / 出貨
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  備註
                </th>
                <th
                  class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  操作
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr
                v-for="(item, index) in filteredItems"
                :key="item.id"
                class="hover:bg-gray-50 transition"
              >
                <td class="px-6 py-4">
                  <div class="text-sm font-bold text-gray-900">
                    {{ item.name }}
                  </div>
                  <div class="text-xs text-gray-500">{{ item.merchant }}</div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm text-gray-900">{{ item.platform }}</div>
                  <div class="text-xs text-gray-500">
                    {{ item.currency }} (匯率: {{ item.rate }})
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm font-bold text-indigo-600">
                    ${{ formatNumber(calculateTotal(item)) }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ item.originalPrice }} × {{ item.quantity }} = {{
                    formatNumber(item.originalPrice * item.quantity) }} {{
                    item.currency }}
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span
                    :class="item.isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full mb-1"
                  >
                    {{ item.isPaid ? '已付款' : '未付款' }}
                  </span>
                  <div class="text-xs text-gray-500">
                    出貨: {{ item.shippingDate || '未定' }}
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                  {{ item.notes }}
                </td>
                <td class="px-6 py-4 text-right text-sm font-medium">
                  <button
                    @click="editItem(item)"
                    class="text-indigo-600 hover:text-indigo-900 mr-3"
                  >
                    <i class="fa-solid fa-pen"></i>
                  </button>
                  <button
                    @click="deleteItem(item.id)"
                    class="text-red-600 hover:text-red-900"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div
            v-if="filteredItems.length === 0"
            class="p-8 text-center text-gray-500"
          >
            目前沒有符合的代購紀錄
          </div>
        </div>

        <div class="md:hidden space-y-4">
          <div
            v-for="item in filteredItems"
            :key="item.id"
            class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"
          >
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="font-bold text-gray-900">{{ item.name }}</h3>
                <p class="text-xs text-gray-500">
                  {{ item.platform }} | {{ item.merchant }}
                </p>
              </div>
              <span
                :class="item.isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                class="px-2 py-0.5 text-xs font-semibold rounded-full"
              >
                {{ item.isPaid ? '已付' : '未付' }}
              </span>
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
              <div class="bg-gray-50 p-2 rounded">
                <span class="text-xs text-gray-400 block">原幣金額</span>
                <span class="font-medium"
                  >{{ item.originalPrice }} {{ item.currency }}</span
                >
              </div>
              <div class="bg-indigo-50 p-2 rounded">
                <span class="text-xs text-indigo-400 block">台幣總計</span>
                <span class="font-bold text-indigo-700"
                  >${{ formatNumber(calculateTotal(item)) }}</span
                >
              </div>
            </div>

            <div class="text-xs text-gray-500 mb-3 space-y-1">
              <p>
                <i class="fa-solid fa-calculator w-4"></i> 數量: {{
                item.quantity }} | 匯率: {{ item.rate }}
              </p>
              <p>
                <i class="fa-solid fa-truck w-4"></i> 出貨: {{ item.shippingDate
                || '未定' }}
              </p>
              <p v-if="item.paymentMethod">
                <i class="fa-solid fa-wallet w-4"></i> 方式: {{
                item.paymentMethod }}
              </p>
              <p v-if="item.notes" class="text-gray-400 italic mt-1">
                {{ item.notes }}
              </p>
            </div>

            <div class="flex justify-end border-t pt-2 gap-3">
              <button @click="editItem(item)" class="text-indigo-600 text-sm">
                <i class="fa-solid fa-pen"></i> 編輯
              </button>
              <button @click="deleteItem(item.id)" class="text-red-500 text-sm">
                <i class="fa-solid fa-trash"></i> 刪除
              </button>
            </div>
          </div>
        </div>
      </div>

      <transition name="fade">
        <div
          v-if="showModal"
          class="fixed inset-0 z-50 overflow-y-auto"
          aria-labelledby="modal-title"
          role="dialog"
          aria-modal="true"
        >
          <div
            class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
          >
            <div
              class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
              @click="closeModal()"
            ></div>
            <span
              class="hidden sm:inline-block sm:align-middle sm:h-screen"
              aria-hidden="true"
              >&#8203;</span
            >

            <div
              class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full"
            >
              <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3
                  class="text-lg leading-6 font-medium text-gray-900 mb-4"
                  id="modal-title"
                >
                  {{ isEditing ? '編輯代購紀錄' : '新增代購紀錄' }}
                </h3>

                <form @submit.prevent="saveItem" class="space-y-4">
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >代購項目</label
                      >
                      <input
                        v-model="form.name"
                        required
                        type="text"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm focus:ring-indigo-500 focus:border-indigo-500"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >代購平台</label
                      >
                      <input
                        v-model="form.platform"
                        type="text"
                        placeholder="例如：Mercari"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                      />
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >商家名字</label
                      >
                      <input
                        v-model="form.merchant"
                        type="text"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >幣值</label
                      >
                      <select
                        v-model="form.currency"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm bg-white"
                      >
                        <option value="JPY">日幣 (JPY)</option>
                        <option value="USD">美金 (USD)</option>
                        <option value="CNY">人民幣 (CNY)</option>
                        <option value="KRW">韓元 (KRW)</option>
                        <option value="TWD">台幣 (TWD)</option>
                        <option value="EUR">歐元 (EUR)</option>
                      </select>
                    </div>
                  </div>

                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="grid grid-cols-3 gap-3">
                      <div>
                        <label class="block text-xs font-medium text-gray-500"
                          >單價(原幣)</label
                        >
                        <input
                          v-model.number="form.originalPrice"
                          type="number"
                          step="0.01"
                          class="mt-1 w-full border-gray-300 rounded p-1 text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-500"
                          >數量</label
                        >
                        <input
                          v-model.number="form.quantity"
                          type="number"
                          class="mt-1 w-full border-gray-300 rounded p-1 text-sm"
                        />
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-500"
                          >匯率</label
                        >
                        <input
                          v-model.number="form.rate"
                          type="number"
                          step="0.0001"
                          class="mt-1 w-full border-gray-300 rounded p-1 text-sm"
                        />
                      </div>
                    </div>
                    <div class="mt-2 text-right">
                      <span class="text-xs text-gray-500"
                        >預估總額(台幣)：</span
                      >
                      <span class="text-lg font-bold text-indigo-600"
                        >${{ formatNumber(Math.round(form.originalPrice *
                        form.quantity * form.rate)) }}</span
                      >
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >出貨時間</label
                      >
                      <input
                        v-model="form.shippingDate"
                        type="date"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700"
                        >收款方式</label
                      >
                      <input
                        v-model="form.paymentMethod"
                        type="text"
                        list="payment-methods"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                      />
                      <datalist id="payment-methods">
                        <option value="轉帳"></option>
                        <option value="LinePay"></option>
                        <option value="現金"></option>
                        <option value="街口"></option>
                      </datalist>
                    </div>
                  </div>

                  <div class="flex items-center mt-2">
                    <input
                      id="paid-status"
                      v-model="form.isPaid"
                      type="checkbox"
                      class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                    />
                    <label
                      for="paid-status"
                      class="ml-2 block text-sm text-gray-900 font-bold"
                    >
                      買家是否已付款？
                    </label>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >備註</label
                    >
                    <textarea
                      v-model="form.notes"
                      rows="2"
                      class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm"
                    ></textarea>
                  </div>

                  <div class="pt-4 flex justify-end gap-3">
                    <button
                      type="button"
                      @click="closeModal()"
                      class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50"
                    >
                      取消
                    </button>
                    <button
                      type="submit"
                      class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none"
                    >
                      {{ isEditing ? '儲存修改' : '新增' }}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const { createApp, ref, computed, watch, onMounted } = Vue;

      createApp({
        setup() {
          // ★ 設定你的 Google Apps Script 網址 ★
          const API_URL =
            "https://script.google.com/macros/s/AKfycbzrfKqSmXKnlXPgxc0_7OHcDSsIHvUo9reeAdqauNoPvzBCh2ryhoG5c04LQi9XYrIP/exec";

          // 資料儲存
          const items = ref([]);
          const searchQuery = ref("");
          const isLoading = ref(false); // 讀取狀態
          const isSaving = ref(false); // 儲存狀態

          // Modal 控制
          const showModal = ref(false);
          const isEditing = ref(false);
          const currentId = ref(null);

          // 表單預設值
          const defaultForm = {
            name: "",
            platform: "",
            merchant: "",
            currency: "JPY",
            originalPrice: 0,
            quantity: 1,
            rate: 0.23,
            isPaid: false,
            shippingDate: "",
            paymentMethod: "",
            notes: "",
          };
          const form = ref({ ...defaultForm });

          // ★ 從 Google Sheet 讀取資料 ★
          const fetchData = async () => {
            isLoading.value = true;
            try {
              const res = await fetch(API_URL);
              const data = await res.json();
              // 確保 ID 是數字或字串，並處理格式
              items.value = data.map((i) => ({
                ...i,
                isPaid: Boolean(i.isPaid),
              }));
            } catch (error) {
              alert("讀取資料失敗，請檢查網路或 Script 設定");
              console.error(error);
            } finally {
              isLoading.value = false;
            }
          };

          // ★ 將資料儲存回 Google Sheet ★
          // 為了避免每打一個字就存檔，我們做一個專門的儲存函數，
          // 並在新增/修改/刪除完成後呼叫
          const syncToCloud = async () => {
            isSaving.value = true;
            try {
              const payload = {
                auth: "moneyflyrecord", // 這裡填跟後端一樣的密碼
                data: items.value, // 這裡才是原本的代購資料
              };
              // 使用 fetch POST 發送 JSON
              // 由於 Google Apps Script 的 CORS 特性，有時需要用 no-cors，
              // 但通常用 text/plain 傳送 JSON 字串是最穩定的 Hack
              await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload),
              });
              console.log("Saved to cloud");
            } catch (error) {
              console.error("Save failed", error);
              alert("儲存失敗！資料可能未同步。");
            } finally {
              isSaving.value = false;
            }
          };

          // 畫面載入時讀取
          onMounted(() => {
            fetchData();
          });

          // 計算邏輯 (維持不變)
          const calculateTotal = (item) =>
            Math.round(item.originalPrice * item.quantity * item.rate);
          const formatNumber = (num) =>
            num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

          // 統計數據 (維持不變)
          const totalPaid = computed(() =>
            items.value
              .filter((i) => i.isPaid)
              .reduce((sum, i) => sum + calculateTotal(i), 0)
          );
          const totalUnpaid = computed(() =>
            items.value
              .filter((i) => !i.isPaid)
              .reduce((sum, i) => sum + calculateTotal(i), 0)
          );
          const filteredItems = computed(() => {
            if (!searchQuery.value) return items.value;
            const lowerQuery = searchQuery.value.toLowerCase();
            return items.value.filter(
              (item) =>
                item.name.toLowerCase().includes(lowerQuery) ||
                (item.merchant &&
                  item.merchant.toLowerCase().includes(lowerQuery)) ||
                (item.notes && item.notes.toLowerCase().includes(lowerQuery))
            );
          });

          // 操作功能
          const openModal = () => {
            isEditing.value = false;
            form.value = { ...defaultForm };
            showModal.value = true;
          };

          const editItem = (item) => {
            isEditing.value = true;
            currentId.value = item.id;
            form.value = JSON.parse(JSON.stringify(item));
            showModal.value = true;
          };

          const closeModal = () => {
            showModal.value = false;
          };

          const saveItem = async () => {
            if (isEditing.value) {
              const index = items.value.findIndex(
                (i) => i.id === currentId.value
              );
              if (index !== -1)
                items.value[index] = { ...form.value, id: currentId.value };
            } else {
              items.value.unshift({ ...form.value, id: Date.now() });
            }
            closeModal();
            await syncToCloud(); // ★ 操作後同步
          };

          const deleteItem = async (id) => {
            if (confirm("確定要刪除這筆紀錄嗎？")) {
              items.value = items.value.filter((i) => i.id !== id);
              await syncToCloud(); // ★ 操作後同步
            }
          };

          return {
            items,
            searchQuery,
            showModal,
            isEditing,
            form,
            filteredItems,
            totalPaid,
            totalUnpaid,
            isLoading,
            isSaving,
            openModal,
            closeModal,
            saveItem,
            editItem,
            deleteItem,
            calculateTotal,
            formatNumber,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
